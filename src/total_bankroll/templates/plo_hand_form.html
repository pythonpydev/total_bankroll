{% extends "base.html" %}
{% from "_macros.html" import page_header %}

{% block content %}
{{ page_header('Pot Limit Omaha Tools', 'Analyze hand strength and calculate Stack-to-Pot Ratio.') }}

<section class="page-section" id="portfolio">
    <div class="container px-4 px-lg-5">
      <div class="plo-form-container">
        <div class="image-container text-center">
          <img src="{{ url_for('static', filename='images/tables/poker_table_pot_btn_chips' ~ button_position ~ '.png') }}" alt="Poker Table" class="poker-table" id="pokerTable">
          <div id="seat-1" class="seat">
            <div class="seat-label">Seat 1</div>
            <div class="position-label"></div>
          </div>
          <div id="seat-2" class="seat">
            <div class="seat-label">Seat 2</div>
            <div class="position-label"></div>
          </div>
          <div id="seat-3" class="seat">
            <div class="seat-label">Seat 3</div>
            <div class="position-label"></div>
          </div>
          <div id="seat-4" class="seat">
            <div class="seat-label">Seat 4</div>
            <div class="position-label"></div>
          </div>
          <div id="seat-5" class="seat">
            <div class="seat-label">Seat 5</div>
            <div class="position-label"></div>
          </div>
          <div id="seat-6" class="seat">
            <div class="seat-label">Seat 6</div>
            <div class="position-label"></div>
          </div>
        </div>
        <form action="{{ url_for('hand_eval.switch_button_position') }}" method="post" class="button-group mt-4">
          {{ button_form.hidden_tag() }}
          <label>Choose button position:</label>
            <button type="submit" name="button_position" value="1" class="btn {% if button_position == 1 %}btn-success{% else %}btn-primary{% endif %} btn-md">1</button>
          <button type="submit" name="button_position" value="2" class="btn {% if button_position == 2 %}btn-success{% else %}btn-primary{% endif %} btn-md">2</button>
          <button type="submit" name="button_position" value="3" class="btn {% if button_position == 3 %}btn-success{% else %}btn-primary{% endif %} btn-md">3</button>
          <button type="submit" name="button_position" value="4" class="btn {% if button_position == 4 %}btn-success{% else %}btn-primary{% endif %} btn-md">4</button>
          <button type="submit" name="button_position" value="5" class="btn {% if button_position == 5 %}btn-success{% else %}btn-primary{% endif %} btn-md">5</button>
            <button type="submit" name="button_position" value="6" class="btn {% if button_position == 6 %}btn-success{% else %}btn-primary{% endif %} btn-md">6</button>
        </form>

        <form id="ploForm" action="{{ url_for('hand_eval.submit_form') }}" method="post" class="poker-form mt-4" novalidate>
          {{ hand_form.hidden_tag() }}
          <div class="row g-3">
            <!-- Blinds -->
            <div class="col-md-6">
              {{ hand_form.small_blind.label(class="form-label") }}
              {{ hand_form.small_blind(class="form-control" + (" is-invalid" if hand_form.small_blind.errors else ""), placeholder="e.g., 1") }}
              {% for error in hand_form.small_blind.errors %}
                <div class="invalid-feedback">{{ error }}</div>
              {% endfor %}
            </div>
            <div class="col-md-6">
              {{ hand_form.big_blind.label(class="form-label") }}
              {{ hand_form.big_blind(class="form-control" + (" is-invalid" if hand_form.big_blind.errors else ""), placeholder="e.g., 2") }}
              {% for error in hand_form.big_blind.errors %}
                <div class="invalid-feedback">{{ error }}</div>
              {% endfor %}
            </div>

            <!-- Hero Info -->
            <div class="col-md-4">
              {{ hand_form.hero_stack.label(class="form-label") }}
              {{ hand_form.hero_stack(class="form-control" + (" is-invalid" if hand_form.hero_stack.errors else ""), placeholder="e.g., 200") }}
              {% for error in hand_form.hero_stack.errors %}
                <div class="invalid-feedback">{{ error }}</div>
              {% endfor %}
            </div>
            <div class="col-md-4">
              {{ hand_form.hero_position.label(class="form-label") }}
              {{ hand_form.hero_position(class="form-select" + (" is-invalid" if hand_form.hero_position.errors else "")) }}
              {% for error in hand_form.hero_position.errors %}
                <div class="invalid-feedback">{{ error }}</div>
              {% endfor %}
            </div>
            <div class="col-md-4">
              {{ hand_form.hero_hand.label(class="form-label") }}
              <div class="input-group">
                {{ hand_form.hero_hand(class="form-control" + (" is-invalid" if hand_form.hero_hand.errors else ""), placeholder="e.g., AsKsQhJh", onfocus="this.blur();", style="cursor: pointer;") }}
                <button class="btn btn-secondary" type="button" data-bs-toggle="modal" data-bs-target="#cardSelectorModal">Select</button>
              </div>
              {% for error in hand_form.hero_hand.errors %}
                <div class="invalid-feedback">{{ error }}</div>
              {% endfor %}
            </div>

            <!-- Opponent Info -->
            <div class="col-md-4">
              {{ hand_form.opponent_stack.label(class="form-label") }}
              {{ hand_form.opponent_stack(class="form-control" + (" is-invalid" if hand_form.opponent_stack.errors else ""), placeholder="e.g., 200") }}
              {% for error in hand_form.opponent_stack.errors %}
                <div class="invalid-feedback">{{ error }}</div>
              {% endfor %}
            </div>
            <div class="col-md-4">
              {{ hand_form.opponent_position.label(class="form-label") }}
              {{ hand_form.opponent_position(class="form-select" + (" is-invalid" if hand_form.opponent_position.errors else "")) }}
              {% for error in hand_form.opponent_position.errors %}
                <div class="invalid-feedback">{{ error }}</div>
              {% endfor %}
            </div>
            <div class="col-md-4">
              {{ hand_form.opponent_hand.label(class="form-label") }}
              {{ hand_form.opponent_hand(class="form-control" + (" is-invalid" if hand_form.opponent_hand.errors else ""), placeholder="e.g., 2s2h3d4c") }}
              {% for error in hand_form.opponent_hand.errors %}
                <div class="invalid-feedback">{{ error }}</div>
              {% endfor %}
            </div>

            <!-- Game State -->
            <div class="col-md-4">
              {{ hand_form.board.label(class="form-label") }}
              {{ hand_form.board(class="form-control" + (" is-invalid" if hand_form.board.errors else ""), placeholder="e.g., AcKcTc") }}
              {% for error in hand_form.board.errors %}
                <div class="invalid-feedback">{{ error }}</div>
              {% endfor %}
            </div>
            <div class="col-md-4">
              {{ hand_form.pot_size.label(class="form-label") }}
              {{ hand_form.pot_size(class="form-control" + (" is-invalid" if hand_form.pot_size.errors else ""), placeholder="e.g., 6") }}
              {% for error in hand_form.pot_size.errors %}
                <div class="invalid-feedback">{{ error }}</div>
              {% endfor %}
            </div>
            <div class="col-md-4">
              {{ hand_form.bet_size.label(class="form-label") }}
              {{ hand_form.bet_size(class="form-control" + (" is-invalid" if hand_form.bet_size.errors else ""), placeholder="e.g., 6") }}
              {% for error in hand_form.bet_size.errors %}
                <div class="invalid-feedback">{{ error }}</div>
              {% endfor %}
            </div>
          </div>
          <div class="d-flex justify-content-center gap-2 mt-4">
            {{ hand_form.submit(class="btn btn-primary") }}
            <button type="button" id="random-button" class="btn btn-secondary">Random</button>
          </div>
        </form>
      </div>
  </section>
  <!-- Card Selector Modal -->
  <div class="modal fade" id="cardSelectorModal" tabindex="-1" aria-labelledby="cardSelectorModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cardSelectorModalLabel">Select 4 Cards for Hero's Hand</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="card-grid">
          {% set ranks = ['A', 'K', 'Q', 'J', 'T', '9', '8', '7', '6', '5', '4', '3', '2'] %}
          {% set suits = ['s', 'h', 'd', 'c'] %}
          {% for suit in suits %}
            {% for rank in ranks %}
              {% set card = rank + suit %}
              <div class="card-item">
                <img src="{{ url_for('static', filename='images/cards/' + card + '.png') }}" alt="{{ card }}" id="{{ card }}" class="img-fluid">
              </div>
            {% endfor %}
          {% endfor %}
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" id="confirm-hero-hand" class="btn btn-primary">Confirm Selection</button>
      </div>
    </div>
  </div>
  </div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const cardSelectorModal = document.getElementById('cardSelectorModal');
    const cardImages = document.querySelectorAll('#cardSelectorModal .card-item img');
    const confirmButton = document.getElementById('confirm-hero-hand');
    const heroHandInput = document.getElementById('hero_hand');
    let selectedCards = [];
    let usedCards = new Set();

    cardImages.forEach(card => {
        card.addEventListener('click', () => {
            const cardId = card.id;

            // Prevent selecting cards used by opponent or board
            const opponentHand = document.getElementById('opponent_hand').value;
            if (usedCards.has(cardId)) {
                // Card is visually disabled, so this is a backup.
                return;
            }

            if (selectedCards.includes(cardId)) {
                // Deselect card
                selectedCards = selectedCards.filter(c => c !== cardId);
                card.classList.remove('selected');
            } else {
                // Select card
                if (selectedCards.length < 4) {
                    selectedCards.push(cardId);
                    card.classList.add('selected');
                } else {
                    alert('You can only select 4 cards for the hero\'s hand.');
                }
            }
        });
    });

    confirmButton.addEventListener('click', () => {
        if (selectedCards.length !== 4) {
            alert('Please select exactly 4 cards.');
            return;
        }
        heroHandInput.value = selectedCards.join('');
        
        // Hide the modal
        var modal = bootstrap.Modal.getInstance(document.getElementById('cardSelectorModal'));
        modal.hide();
    });

    // When the modal is about to be shown, update which cards are disabled
    cardSelectorModal.addEventListener('show.bs.modal', function () {
        // Reset selections and used cards
        selectedCards = [];
        usedCards.clear();

        // Get cards from other fields
        const opponentHand = document.getElementById('opponent_hand').value;
        const board = document.getElementById('board').value;
        const allUsedCardsStr = opponentHand + board;
        for (let i = 0; i < allUsedCardsStr.length; i += 2) {
            usedCards.add(allUsedCardsStr.substring(i, i + 2));
        }

        // Update visual state of all cards
        cardImages.forEach(card => {
            card.classList.remove('selected', 'disabled');
            if (usedCards.has(card.id)) {
                card.classList.add('disabled');
            }
        });
    });
});
</script>
<style>
    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
      gap: 5px;
    }
    .card-item img {
      width: 100%;
      cursor: pointer;
      border: 3px solid transparent;
      border-radius: 5px;
    }
    .card-item img.selected {
      border-color: #0d6efd; /* Bootstrap primary blue */
      box-shadow: 0 0 8px #0d6efd;
    }
    .card-item img.disabled {
      filter: grayscale(100%);
      cursor: not-allowed;
    }
</style>
{% endblock %}