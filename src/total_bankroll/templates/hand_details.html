{% extends "base.html" %}

{% block head %}
  {{ super() }}
{% endblock %}

{% block content %}
  <div class="center-content">
    <h2>Submitted Poker Hand Details</h2>
    <div class="data-display-container">
      <div class="row mb-4">
        <!-- Left Column for Hand Data -->
        <div class="col-lg-6">
          <div class="row">
            <div class="col-sm-6"><strong>Small Blind:</strong> {{ form_data.small_blind|int }}</div>
            <div class="col-sm-6"><strong>Big Blind:</strong> {{ form_data.big_blind|int }}</div>
            <div class="col-sm-6"><strong>Pot Size:</strong> {{ form_data.pot_size|int }}</div>
            <div class="col-sm-6"><strong>Bet Size:</strong> {{ form_data.bet_size|int }}</div>
            <div class="col-sm-6"><strong>Hero's Stack:</strong> {{ form_data.hero_stack|int }}</div>
            <div class="col-sm-6"><strong>Opponent's Stack:</strong> {{ form_data.opponent_stack|int }}</div>
            <div class="col-sm-6"><strong>Hero's Position:</strong> {{ form_data.hero_position }}</div>
            <div class="col-sm-6"><strong>Opponent's Position:</strong> {{ form_data.opponent_position }}</div>
            <div class="col-sm-6"><strong>Button Position:</strong> {{ form_data.button_position }}</div>
          </div>
        </div>
        <!-- Right Column for Card Images -->
        <div class="col-lg-6">
        <div class="card-display-row">
          <p><strong>Hero's Hand:</strong></p>
          <span id="heroHand"></span>
        </div>
        <div class="card-display-row">
          <p><strong>Board Cards:</strong></p>
          <span id="boardCards"></span>
        </div>
        <div class="card-display-row">
          <p><strong>Opponent's Hand:</strong></p>
          <span id="opponentHand"></span>
        </div>
        </div>
      </div>
    </div>

    <div class="data-display">
      <div class="center-content">
      <h2>Guess the SPR</h2>
      </div>
      <form id="sprGuessForm" class="spr-guess-form">
        <div class="form-group d-flex align-items-center mb-3">
          <div class="flex-grow-1 me-3">
            <label for="sprGuess">Guess the SPR:</label>
            <input type="number" id="sprGuess" name="sprGuess" step="0.01" required class="form-control">
          </div>
          <div id="actualSpr" class="spr-result" role="status" aria-live="polite"></div>
        </div>
        <div class="form-group d-flex align-items-center mb-3">
          <div class="flex-grow-1 me-3">
            <label for="potBetsGuess">Guess number of pot sized bets:</label>
            <input type="number" id="potBetsGuess" name="potBetsGuess" step="0.01" required class="form-control">
          </div>
          <div id="actualPotBets" class="spr-result" role="status" aria-live="polite"></div>
        </div>
        <div class="d-grid gap-2">
            <button type="submit" class="btn btn-outline-light">Submit Answers</button>
        </div>
      </form>
      <div class="d-grid gap-2 mt-3">
        <a href="/hand_evaluation" class="btn btn-outline-info">View Hand Evaluation</a>
        <a href="{{ url_for('hand_eval.plo_hand_form') }}" class="btn btn-outline-secondary">Setup New Hand</a>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Data from Flask template
      const heroHand = sortCards({{ form_data.hero_hand|tojson }});
      const boardCards = sortCards({{ form_data.board|tojson }});
      const opponentHand = sortCards({{ form_data.opponent_hand|tojson }});
      const actualSpr = {{ form_data.actual_spr|tojson }};
      const actualPotBets = {{ form_data.actual_pot_bets|tojson }};

      // DOM Elements for card display
      const heroHandContainer = document.getElementById('heroHand');
      const boardCardsContainer = document.getElementById('boardCards');
      const opponentHandContainer = document.getElementById('opponentHand');
      const cardImagePath = `{{ url_for('static', filename='images/cards/') }}`;

      // Display the sorted cards
      displayCards(heroHand, heroHandContainer, cardImagePath);
      displayCards(boardCards, boardCardsContainer, cardImagePath);
      displayCards(opponentHand, opponentHandContainer, cardImagePath);

      // Cache DOM elements
      const sprGuessInput = document.getElementById('sprGuess');
      const potBetsGuessInput = document.getElementById('potBetsGuess');
      const actualSprDiv = document.getElementById('actualSpr');
      const actualPotBetsDiv = document.getElementById('actualPotBets');

      const SPR_TOLERANCE = 0.05;

      document.getElementById('sprGuessForm').addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent default form submission

        const sprGuess = parseFloat(sprGuessInput.value);
        const potBetsGuess = parseFloat(potBetsGuessInput.value);

        if (actualSpr !== null) {
          const sprText = `Actual SPR: ${actualSpr.toFixed(2)}`;
          const sprCalcStr = `{{ form_data.actual_spr_calculation_str|safe }}`; // Get the calculation string
          const tolerance = actualSpr * SPR_TOLERANCE;
          if (Math.abs(sprGuess - actualSpr) <= tolerance) {
            actualSprDiv.innerHTML = `<span class="text-success">${sprText} &#10004; ${sprCalcStr}</span>`;
          } else {
            actualSprDiv.innerHTML = `<span class="text-danger">${sprText} &#10060; ${sprCalcStr}</span>`;
          }
        } else {
          actualSprDiv.textContent = 'Actual SPR: N/A';
        }

        const potBetsText = `Actual Pot Sized Bets: ${actualPotBets}`;
        if (potBetsGuess === actualPotBets) {
          actualPotBetsDiv.innerHTML = `<span class="text-success">${potBetsText} &#10004;</span>`;
        } else {
          actualPotBetsDiv.innerHTML = `<span class="text-danger">${potBetsText} &#10060;</span>`;
        }
      });
    });
  </script>
{% endblock %}