{% extends "core/base.html" %}
{% from "partials/_macros.html" import page_header %}

{% block content %}
{{ page_header('Tournament Stakes', 'Choose game, skill level, risk tolerance, and environment for tailored recommendations.') }}

<section class="page-section" id="tournament_stakes_form">
    <div class="container px-4 px-lg-5">
        <form method="GET" action="{{ url_for('tools.tournament_stakes_page') }}" class="row g-3 justify-content-center">
            <!-- Game Type -->
            <div class="col-md-2">
                <label for="game_type" class="form-label">Game Type</label>
                <select id="game_type" name="game_type" class="form-select">
                    <option value="nlhe" {% if game_type == 'nlhe' %}selected{% endif %}>NLHE</option>
                    <option value="plo" {% if game_type == 'plo' %}selected{% endif %}>PLO</option>
                    <option value="limit_holdem" {% if game_type == 'limit_holdem' %}selected{% endif %}>Limit Hold'em</option>
                    <option value="na" {% if game_type == 'na' %}selected{% endif %}>N/A</option>
                </select>
            </div>
            <!-- Skill Level -->
            <div class="col-md-2">
                <label for="skill_level" class="form-label">Skill Level</label>
                <select id="skill_level" name="skill_level" class="form-select">
                    <option value="tough" {% if skill_level == 'tough' %}selected{% endif %}>Tough Games</option>
                    <option value="soft" {% if skill_level == 'soft' %}selected{% endif %}>Soft Games</option>
                    <option value="na" {% if skill_level == 'na' %}selected{% endif %}>N/A</option>
                </select>
            </div>
            <!-- Risk Tolerance -->
            <div class="col-md-2">
                <label for="risk_tolerance" class="form-label">Risk Tolerance</label>
                <select id="risk_tolerance" name="risk_tolerance" class="form-select">
                    <option value="conservative" {% if risk_tolerance == 'conservative' %}selected{% endif %}>Conservative</option>
                    <option value="aggressive" {% if risk_tolerance == 'aggressive' %}selected{% endif %}>Aggressive</option>
                    <option value="na" {% if risk_tolerance == 'na' %}selected{% endif %}>N/A</option>
                </select>
            </div>
            <!-- Game Environment -->
            <div class="col-md-2">
                <label for="game_environment" class="form-label">Environment</label>
                <select id="game_environment" name="game_environment" class="form-select">
                    <option value="online" {% if game_environment == 'online' %}selected{% endif %}>Online</option>
                    <option value="live" {% if game_environment == 'live' %}selected{% endif %}>Live</option>
                    <option value="na" {% if game_environment == 'na' %}selected{% endif %}>N/A</option>
                </select>
            </div>
            <!-- Site Filter -->
            <div class="col-md-2">
                <label for="site_filter" class="form-label">Filter by Site</label>
                <select id="site_filter" name="site_filter" class="form-select">
                    <option value="all" {% if site_filter == 'all' %}selected{% endif %}>All Sites</option>
                    <option value="pokerstars" {% if site_filter == 'pokerstars' %}selected{% endif %}>PokerStars</option>
                    <option value="gg" {% if site_filter == 'gg' %}selected{% endif %}>GG Poker</option>
                    <option value="partypoker" {% if site_filter == 'partypoker' %}selected{% endif %}>PartyPoker</option>
                </select>
            </div>
            <div class="col-12 text-center mt-4">
                <button type="submit" class="btn btn-primary">Get Recommendation</button>
            </div>
        </form>
    </div>
</section>

<section class="page-section bg-light" id="tournament_stakes_content">
    <div class="container px-4 px-lg-5">
        <div class="row gx-4 gx-lg-5 justify-content-center">
            <div class="col-lg-10 text-center">
                <h2 class="mt-0">Tournament Stakes Recommendations</h2>
                <hr class="divider" />
                <p class="text-muted mb-4">Your current total bankroll is: <span class="fw-bold">${{ "%.2f" | format(total_bankroll) }}</span></p>
                
                {% if tournament_bankroll_recommendation %}
                <div class="alert alert-secondary" role="alert">
                    Based on your selections, a bankroll of <span class="fw-bold">{{ tournament_bankroll_recommendation }}</span> is recommended for your chosen tournament type.
                </div>
                {% endif %}

                {% if stake_explanation %}
                <div class="alert alert-bankroll-safe border" role="alert">
                    {{ stake_explanation }}
                </div>
                {% endif %}

                {% if next_stake_message %}
                <div class="alert alert-danger" role="alert">
                    <i class="bi bi-arrow-up-circle-fill"></i> {{ next_stake_message }}
                </div>
                {% endif %}

                {% if move_down_message %}
                <div class="alert alert-info" role="alert">
                    <i class="bi bi-arrow-down-circle-fill"></i> {{ move_down_message }}
                </div>
                {% endif %}
            </div>
        </div>

        <div class="row gx-4 gx-lg-5 mt-5">
            {% for site_key, site_data in tournament_buy_ins.items() %}
                {% if site_filter == 'all' or site_filter == site_key %}
                <div class="col-lg-12 mb-5">
                    <h3 class="text-center">{{ site_data.name }}</h3>
                    <p class="text-center text-muted">{{ site_data.description }}</p>
                    <div class="table-responsive">
                        <table class="table-custom">
                            <thead>
                                <tr>
                                    <th>Buy-In</th>
                                    <th>Examples/Notes</th>
                                    <th>Bankroll Required</th>
                                    <th>Additional $ Required</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in site_data.buy_ins %}
                                    {% set recs = site_data.get('recommendations') %}
                                    {% set row_class = '' %}
                                    {% if recs and item.buy_in_dec == recs.get('recommended_tournament_stake_dec') %}
                                        {% set row_class = 'highlight-recommended' %}
                                    {% elif recs and item.buy_in_dec == recs.get('next_stake_level_dec') %}
                                        {% set row_class = 'highlight-move-up' %}
                                    {% elif recs and item.buy_in_dec == recs.get('move_down_stake_level_dec') %}
                                        {% set row_class = 'highlight-move-down' %}
                                    {% endif %}
                                    <tr class="{{ row_class }}">
                                        <td>{{ item.buy_in }}</td>
                                        <td>{{ item.notes }}</td>
                                        <td>{{ item.bankroll_required }}</td>
                                        <td>{{ item.additional_required }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>
</section>

<style>
    .highlight-recommended {
        background-color: #d4edda !important; /* Light green */
        color: #155724;
    }
    .highlight-move-up {
        background-color: #f8d7da !important; /* Light red */
        color: #721c24;
    }
    .highlight-move-down {
        background-color: #cce5ff !important; /* Light blue */
        color: #004085;
    }

    /* Dark Mode Overrides */
    body.dark-mode .table-custom tbody tr.highlight-recommended {
        background-color: #1c4b27 !important; /* Darker, rich green */
        color: #d4edda;
    }
    body.dark-mode .table-custom tbody tr.highlight-move-up {
        background-color: #5a1a21 !important; /* Darker, rich red */
        color: #f8d7da;
    }
    body.dark-mode .table-custom tbody tr.highlight-move-down {
        background-color: #003366 !important; /* Darker, rich blue */
        color: #cce5ff;
    }
</style>
{% endblock %}